<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>MapleStory</title>
    <link rel="shortcut icon" type="image/x-icon" href="http://i.imgur.com/PrMviU0.png"/>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<div id="game"></div>
    <script src="http://code.jquery.com/jquery-1.12.0.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.4.6/phaser.min.js" charset="utf-8"></script>
    <script src="arcade.slope.js" charset="utf-8"></script>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" charset="utf-8"></script>
    <script src="phaser_nchuit_helper.js" charset="utf-8"></script>
    <script>
        var game = {
          new: function(witdh, height, canvas_selector){
            this.phaser = new Phaser.Game(witdh, height, Phaser.AUTO, canvas_selector, this)
          },
          preload: function(){
            var phaser = this.phaser;
            phaser.load.image('sky', 'assets/bg.jpg');
            phaser.load.image('star', 'assets/star.png');
            phaser.load.spritesheet('player', 'assets/player.png', 95, 160);
            phaser.load.spritesheet('monster', 'assets/baddie.png', 32, 32);  
            phaser.load.tilemap('map', 'tilemap/map.json', null, Phaser.Tilemap.TILED_JSON);
            phaser.load.image('kenney', 'tilemap/kenney.png');

          },
          create: function(){
            var phaser = this.phaser;
            //  create and put objects into the game
            //  We're going to be using physics, so enable the Arcade Physics system
            phaser.physics.startSystem(Phaser.Physics.ARCADE);

            var background = phaser.add.sprite(0, 0, 'sky');
            // background.height = layer.height
            // background.width = layer.width

            // 加入地圖
            var map = phaser.add.tilemap('map');
            map.addTilesetImage('kenney');
            // 設定"碰撞"性質
            map.setCollision(PhaserHelper.getCollisionIndexes(phaser, 'map'));

            var layer = map.createLayer('layer1');
            layer.bringToTop();
            layer.resizeWorld();

            var tiles = map.layers[0].data

            background.height = layer.height
            background.width = layer.width

            // 加入人物
            var player = phaser.add.sprite(32, 150, 'player');
            player.scale.setTo(0.7,0.7) //設定人物的大小

            // 啟用人物的物理效果
            phaser.physics.arcade.enable(player);

            // y軸加速度
            player.body.gravity.y = 1200;

            // 向左向右 人物移動時的動畫效果
            player.animations.add('left', [0, 1, 2, 3], 10, true);
            player.animations.add('right', [5, 6, 7, 8], 10, true);
            player.bringToTop
            phaser.camera.follow(player);
            // 地圖碰撞
            player.body.checkCollision.up = false;
            player.body.checkCollision.left = false;
            player.body.checkCollision.right = false;


            var monster = phaser.add.sprite(100, 350, 'monster');
            phaser.physics.arcade.enable(monster);
            monster.body.bounce.y = 0.2;
            monster.body.gravity.y = 300;
            monster.body.collideWorldBounds = true;

            monster.animations.add('left', [0, 1], 10, true);
            monster.animations.add('right', [2, 3], 10, true);
            monster.bringToTop;
            monster.body.checkCollision.up = false;
            monster.body.checkCollision.left = false;
            monster.body.checkCollision.right = false;

            monster.body.velocity.x = 100;
            monster.animations.play('right');


            //  Finally some stars to collect
            var stars = phaser.add.group();

            //  We will enable physics for any star that is created in this group
            stars.enableBody = true;
            stars.bringToTop;

            //  Here we'll create 12 of them evenly spaced apart
            for (var i = 0; i < 12; i++)
            {
                //  Create a star inside of the 'stars' group
                var star = stars.create(i * 70, 0, 'star');

                //  Let gravity do its thing
                star.body.gravity.y = 300;

                //  This just gives each star a slightly random bounce value
                star.body.bounce.y = 0.7 + Math.random() * 0.2;
            }

            //  The score
            this.score = 0;
            var scoreText = phaser.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

            //  Our controls.
            var cursors = phaser.input.keyboard.createCursorKeys();

            this.map = map;
            this.layer = layer;
            this.tiles = tiles;
            this.player = player;
            this.stars = stars;
            this.scoreText = scoreText;
            this.cursors = cursors;
            this.monster = monster;
            
          },
          update: function(){
            var phaser = this.phaser;
            var cursors = this.cursors;
            var player = this.player;
            var layer = this.layer;
            var stars = this.stars;
            var monster = this.monster;
            //  executed 30 times per second, pushing the game forward
            //  Collide the player and the stars with the platforms
            var touching_ground = phaser.physics.arcade.collide(player, layer);
            phaser.physics.arcade.collide(stars, layer);
            phaser.physics.arcade.collide(monster, layer);

            

            //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
            phaser.physics.arcade.overlap(player, stars, this.collectStar, null, this);

            //  Reset the players velocity (movement)
            player.body.velocity.x = 0;

            if (cursors.left.isDown)
            {
                //  Move to the left
                player.body.velocity.x = -150;

                player.animations.play('left');

                // stop in the air
                if (!touching_ground) {
                    player.animations.stop();
                    if (player.frame < 4) {
                        player.frame = 0;
                    }
                }
            }
            else if (cursors.right.isDown)
            {
                //  Move to the right
                player.body.velocity.x = 150;

                player.animations.play('right');

                if (!touching_ground) {
                    player.animations.stop();
                    if (player.frame >= 4) {
                        player.frame = 8;
                    }
                }
            }
            //  Allow the player to jump if they are touching the ground.
            
            else
            {
                //  Stand still
                player.animations.stop();
                if (player.frame < 4) {
                    player.frame = 3;
                }
                if (player.frame >= 4) {
                    player.frame = 5;
                }
            }

            if (cursors.up.isDown && touching_ground)
            {
                player.body.velocity.y = -720;
            }


            // monster behavior
            // console.log(monster.body.x)
            if (monster.body.x >  350) {
                monster.body.velocity.x = -100;
                monster.animations.play('left');
            }
            if (monster.body.x < 180) {
                monster.body.velocity.x = 100;
                monster.animations.play('right');
            }
            
             
            

          },
          collectStar: function(player, star){
            var phaser = this.phaser;
            // var star = this.star;
            var scoreText = this.scoreText;
            // Removes the star from the screen
            star.kill();

            //  Add and update the score
            this.score += 10;
            scoreText.text = 'Score: ' + this.score;

          }
        };

        jQuery(document).ready(function($) {
          game.new($(document).width(), $(document).height(), 'game');
        });
                
    </script>


</body>
</html>
